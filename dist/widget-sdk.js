const t="1.0.0",e="Widget SDK: ",i=/^[A-Za-z0-9._-]{3,128}$/,o=["https://console.pixelbin.io","https://console.pixelbinz0.de"],r="WIDGET_READY",n="WIDGET_OPENED",s="WIDGET_CLOSED",a="WIDGET_ERROR",h="WIDGET_LOGOUT",d="WIDGET_NAVIGATED",l="WIDGET_SESSION_EXPIRED",c="SDK_INIT",g="SDK_OPEN",_="SDK_CLOSE",u="SDK_NAVIGATE",p="SDK_LOGOUT",m={params:{widgetType:"ai-editor"},autostart:!1,autoDestroyOnFatalError:!0,allowedIframeFeatures:["clipboard-read","clipboard-write","camera","microphone","geolocation","fullscreen","web-share","autoplay","display-capture"],style:{position:"relative",width:"100%",height:"100%",border:"0",borderRadius:"12px",display:"none"},debug:!1,routePath:"/widget",bootstrap:{token:null,getToken:null,endpoint:null,method:"GET",headers:{},payload:null,timeoutMs:1e4}},f=5e3,w=new Set(["CONFIG_MISSING","CONFIG_INVALID_DOM_NODE","CONFIG_INVALID_ORIGIN","CONFIG_INVALID_EMBED_ID","CONFIG_DUPLICATE_INIT","COMM_INIT_TIMEOUT"]),y="CONFIG_MISSING",T="CONFIG_INVALID_DOM_NODE",O="CONFIG_INVALID_ORIGIN",I="CONFIG_INVALID_EMBED_ID",E="CONFIG_DUPLICATE_INIT",b="AUTH_TOKEN_MISSING",N="AUTH_TOKEN_INVALID",v="AUTH_TOKEN_TIMEOUT",D="AUTH_TOKEN_SOURCE_INVALID",k="AUTH_BOOTSTRAP_GETTOKEN_INVALID",A="AUTH_BOOTSTRAP_ENDPOINT_INVALID",S="AUTH_BOOTSTRAP_METHOD_INVALID",M="AUTH_ENDPOINT_FAILED",R="AUTH_ENDPOINT_NO_TOKEN",P="COMM_INIT_TIMEOUT",G="COMM_POSTMESSAGE_FAILED",C="COMM_LOGOUT_TIMEOUT",L="COMM_INVALID_ORIGIN",U="RUNTIME_DESTROYED",H="RUNTIME_NOT_READY",j="RUNTIME_INVALID_URL",W="NETWORK_FETCH_FAILED",F="NETWORK_TIMEOUT",x="UNKNOWN",K={[y]:"Configuration object is required",[T]:"Invalid domNode: must be an HTMLElement or valid CSS selector",[O]:"Invalid widgetOrigin: must be an allowed origin URL",[I]:"Invalid embedId format: must match pattern [A-Za-z0-9._-]{3,128}",[E]:"Widget already initialized on this domNode",[b]:"Bootstrap token is required but not provided",[N]:"Bootstrap token is invalid or malformed",[v]:"Bootstrap token request timed out",[D]:"No valid token source configured (provide getToken or endpoint)",[k]:"bootstrap.getToken must be a function",[A]:"bootstrap.endpoint must be a valid URL string",[S]:"bootstrap.method must be GET or POST",[M]:"Token endpoint request failed",[R]:"Token endpoint did not return a valid token",[P]:"Widget initialization handshake timed out",[G]:"Failed to send message to widget iframe",[C]:"Widget logout acknowledgement timed out",[L]:"Message origin does not match widget origin",[U]:"Widget has been destroyed",[H]:"Widget is not ready yet",[j]:"Invalid URL format for widget origin",[W]:"Network request failed",[F]:"Network request timed out",[x]:"An unknown error occurred"},V=t=>"string"==typeof t,q=t=>{if(t instanceof HTMLElement)return t;if(V(t)){const i=document.querySelector(t);if(!i)throw new Error("".concat(e,"Invalid DOM node: selector not found: ").concat(t));return i}throw new Error("".concat(e,"Invalid DOM node: domNode must be an element or selector"))},z=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i={};for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(i[e]=t[e]);for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=e[t]);return i};class B{constructor(){this._ev={}}on(t,e){return(this._ev[t]=this._ev[t]||[]).push(e),this}off(t,e){const i=this._ev[t];return i?(this._ev[t]=i.filter(t=>t!==e),this):this}once(t,e){var i=this;const o=function(){try{e(...arguments)}finally{i.off(t,o)}};return this.on(t,o)}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),o=1;o<e;o++)i[o-1]=arguments[o];(this._ev[t]||[]).forEach(t=>{try{t(...i)}catch(t){setTimeout(()=>{throw t},0)}})}}class Y{constructor(t){this.enabled=!!t}log(){if(this.enabled)try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.log("[WidgetSDK]",...e)}catch(t){}}error(){try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.error("[WidgetSDK]",...e)}catch(t){}}warn(){try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.warn("[WidgetSDK]",...e)}catch(t){}}}class J extends Error{constructor(t,i){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("string"==typeof t&&!i)return super("".concat(e).concat(t)),this.name="SdkError",this.code="UNKNOWN",void(this.context={});super("".concat(e,"[").concat(t,"] ").concat(i)),this.name="SdkError",this.code=t,this.context=o,Error.captureStackTrace&&Error.captureStackTrace(this,J)}toJSON(){return{name:this.name,code:this.code,message:this.message,context:this.context,stack:this.stack}}getUserMessage(){return this.message.replace(e,"").replace(/^\[.*?\]\s*/,"")}}function Q(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,o)}return i}function Z(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Q(Object(i),!0).forEach(function(e){$(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Q(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function $(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const X=(t,i)=>{const o=document.createElement("iframe");o.src=((t,i,o)=>{if(!/^https?:\/\//.test(t))throw new Error("".concat(e,"widgetOrigin must be absolute (https://...)"));const r=V(i)&&i.length>0?i.startsWith("/")?i:"/".concat(i):"",n=new URL(t.replace(/\/$/,"")+r);return Object.keys(o||{}).forEach(t=>{const e=o[t];null!=e&&n.searchParams.set(t,String(e))}),n.toString()})(t.widgetOrigin,t.routePath,Z(Z({},t.params),{},{embedId:t.embedId})),o.sandbox=["allow-scripts","allow-forms","allow-popups","allow-same-origin"].join(" "),o.referrerPolicy="origin-when-cross-origin",o.allow=(t.allowedIframeFeatures||[]).join("; "),o.loading="eager",o.setAttribute("aria-label","Pixelbin Widget"),o.setAttribute("data-widget-sdk","true"),o.setAttribute("data-widget-type",t.params.widgetType),null!=t.embedId&&o.setAttribute("data-embed-id",String(t.embedId)),Object.assign(o.style,m.style,t.style||{});return q(t.domNode).appendChild(o),i("iframe created",o.src),o};class tt{constructor(t,e,i){this._logger=t,this._post=e,this._emitError=i,this._initAck=!1,this._initRetryHandle=null,this._initRetryAttempts=0}start(t,e){this._initAck=!1,this._initRetryAttempts=0,this._onReady=e;const i=()=>{if(this._logger.log("INIT attempt",this._initRetryAttempts+1),this._post(c,t),this._initAck)this.clear();else{if(this._initRetryAttempts>=9){this.clear(),this._logger.error("INIT handshake timed out");const t=new J(P,K[P],{attempts:10,intervalMs:500});return void this._emitError(t)}this._initRetryAttempts+=1,this.clear(),this._initRetryHandle=window.setTimeout(i,500)}};this.clear(),i()}handleReady(){this._initAck=!0,this.clear(),this._onReady&&this._onReady()}clear(){this._initRetryHandle&&(clearTimeout(this._initRetryHandle),this._initRetryHandle=null)}isAcknowledged(){return this._initAck}}class et{constructor(t,e){this._logger=t,this._post=e,this._pending=null,this._timer=null}execute(t,e){const{path:i,widgetType:o,params:r,timeout:n=f}=t;return new Promise((t,s)=>{e(()=>{if(this._pending)return void s(new Error("Navigation already in progress"));const e={};o&&(e.widgetType=o),i&&(e.path=i),r&&(e.params=r),this._pending={resolve:t,reject:s,payload:e},this._post(u,e),this._timer=window.setTimeout(()=>{if(this._pending){this._logger.warn("Navigate acknowledgement timed out");const{reject:t}=this._pending;this._pending=null,this.clear(),t(new Error("Navigation timeout"))}},n)})})}handleAck(t){if(!this._pending)return;const{resolve:e,reject:i}=this._pending;if(this._pending=null,this.clear(),null!=t&&t.error||!1===(null==t?void 0:t.success)){this._logger.error("Navigation failed",t);const e=(null==t?void 0:t.error)||(null==t?void 0:t.message)||"Navigation failed";i(new Error(e))}else this._logger.log("Navigation successful",t),e(t||{})}clear(){this._timer&&(clearTimeout(this._timer),this._timer=null)}cleanup(){this._pending&&(this._pending.reject(new Error("Widget destroyed")),this._pending=null),this.clear()}isPending(){return null!==this._pending}}class it{constructor(t,e){this._logger=t,this._post=e,this._pending=!1,this._timer=null}start(t){if(this._pending)return!1;this._pending=!0,this._onComplete=t;try{this._post(p,{reason:"destroy"})}catch(e){return this._logger.error("Failed to send LOGOUT",e),this._pending=!1,t&&t(),!1}return this._timer=window.setTimeout(()=>{this._logger.warn("LOGOUT acknowledgement timed out; forcing destroy"),this._pending=!1,this._onComplete&&this._onComplete()},2e3),!0}handleAck(){this._pending&&(this._pending=!1,this.clear(),this._onComplete&&this._onComplete())}clear(){this._timer&&(clearTimeout(this._timer),this._timer=null)}isPending(){return this._pending}}class ot{constructor(t){this._validateConfig(t),this.config=z(m,t),this._logger=new Y(!!this.config.debug),this._em=new B,this._ready=!1,this._destroyed=!1,this._queue=[],this._reinitializing=!1,this._initHandler=new tt(this._logger,this._post.bind(this),this._emitError.bind(this)),this._navigateHandler=new et(this._logger,this._post.bind(this)),this._logoutHandler=new it(this._logger,this._post.bind(this)),this._setupFrameAndInit()}_setupFrameAndInit(){var e=this;const i=this.config.bootstrap||{},o=!(!i.getToken&&!i.endpoint||i.token),r="btToken",n=()=>{if(q(this.config.domNode).querySelector('iframe[data-widget-sdk="true"]'))throw new J(E,K[E],{domNode:this.config.domNode});const o=this.config.bootstrap&&this.config.bootstrap.token?z(this.config,{params:z(this.config.params||{},{[r]:i.token})}):this.config;this._logger.log("cfgForIframe",o),this.iframe=X(o,function(){return e._logger.log(...arguments)}),this._onMessage=this._handleMessage.bind(this),window.addEventListener("message",this._onMessage,!1);const n=()=>{const e={version:t,token:null,parentOrigin:window.location.origin,params:this.config.params||{}};null!=this.config.embedId&&(e.embedId=this.config.embedId),this._initHandler.start(e,()=>{this._ready=!0,this._flushQueue(),this._em.emit("ready"),this.config.autostart&&this.open()})};this.iframe.contentWindow&&this.iframe.contentDocument&&"complete"===this.iframe.contentDocument.readyState?n():this.iframe.addEventListener("load",n,{once:!0})};!o||this.config.bootstrap&&this.config.bootstrap.token?n():this._resolveToken().then(t=>{this.config.bootstrap.token=t,n()}).catch(t=>{this._logger.error("Token error",t),this._emitError(t,!1)})}_validateConfig(t){if(!t)throw new J(y,K[y]);if(!t.domNode)throw new J(T,K[T],{provided:t.domNode});if(!t.widgetOrigin)throw new J(O,"widgetOrigin is required (e.g. https://console.pixelbin.io)",{allowed:o});if(-1===o.indexOf(String(t.widgetOrigin)))throw new J(O,K[O],{provided:t.widgetOrigin,allowed:o});if(null!=t.embedId){const e=String(t.embedId);if(!i.test(e))throw new J(I,K[I],{provided:e,pattern:i.toString()})}if(t.bootstrap){const e=t.bootstrap;if(e.getToken&&"function"!=typeof e.getToken)throw new J(k,K[k],{type:typeof e.getToken});if(e.endpoint&&"string"!=typeof e.endpoint)throw new J(A,K[A],{type:typeof e.endpoint});if(e.method&&!["GET","POST"].includes(String(e.method).toUpperCase()))throw new J(S,K[S],{provided:e.method,allowed:["GET","POST"]})}}_post(t,e){if(this._destroyed)return;const i=this.config.widgetOrigin,o={type:t,payload:e||{},requestId:"w_".concat(Math.random().toString(36).slice(2)).concat(Date.now().toString(36))};this._logger.log("postMessage →",i,o);try{this.iframe.contentWindow.postMessage(o,i)}catch(e){this._logger.error("postMessage failed",e);const i=new J(G,K[G],{type:t,originalError:e.message});this._emitError(i)}}_emitError(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=t instanceof J?{code:t.code,message:t.getUserMessage(),context:t.context}:{code:x,message:t.message,context:{}};this._em.emit("error",i);const o=null!==e?e:t instanceof J&&w.has(t.code),r=!1!==this.config.autoDestroyOnFatalError;o&&r&&!this._destroyed&&(this._logger.warn("Fatal error [".concat(i.code,"]: Auto-destroying widget")),setTimeout(()=>{this._destroyed||this._finishDestroy()},0))}_handleMessage(t){if(t.source!==this.iframe.contentWindow)return;if(t.origin!==this.config.widgetOrigin)return;const e=t.data||{};if(e&&e.type)switch(this._logger.log("message ←",t.origin,e),e.type){case r:this._initHandler.handleReady();break;case n:this._em.emit("open"),this._show();break;case s:this._em.emit("close"),this._hide();break;case a:this._em.emit("error",e.payload||{});break;case h:this._em.emit("logout",e.payload),this._logoutHandler.handleAck();break;case d:this._em.emit("navigate",e.payload),this._navigateHandler.handleAck(e.payload);break;case l:this._handleSessionExpired(e.payload)}}_handleSessionExpired(t){if(!this._reinitializing&&!this._destroyed){this._logger.warn("Session expired, reinitializing widget...",t),this._reinitializing=!0,this._ready=!1,this._queue=[];try{window.removeEventListener("message",this._onMessage,!1),this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe)}catch(t){this._logger.error("Error cleaning up during reinitialization",t)}this.config.bootstrap&&(this.config.bootstrap.token=null),setTimeout(()=>{this._reinitializing=!1,this._setupFrameAndInit()},100)}}_flushQueue(){const t=this._queue.splice(0,this._queue.length);for(let e=0;e<t.length;e++)t[e]()}_ensureReady(t){this._ready?t():this._queue.push(t)}_show(){this.iframe.style.display="block"}_hide(){this.iframe.style.display="none"}open(){return this._ensureReady(()=>{this._post(g),this._show()}),this}close(){return this._ensureReady(()=>{this._post(_),this._hide()}),this}navigate(t){return this._navigateHandler.execute(t||{},this._ensureReady.bind(this))}updateConfig(t){return(e=t)&&"object"==typeof e?(this.config=z(this.config,t),this):this;var e}on(t,e){return this._em.on(t,e),this}off(t,e){return this._em.off(t,e),this}once(t,e){return this._em.once(t,e),this}destroy(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{force:e=!1}=t;this._destroyed||(!e&&this.iframe&&this.iframe.contentWindow?this._logoutHandler.isPending()||this._logoutHandler.start(()=>{this._finishDestroy()}):this._finishDestroy())}_finishDestroy(){if(!this._destroyed){this._destroyed=!0,this._initHandler.clear(),this._logoutHandler.clear(),this._navigateHandler.cleanup();try{window.removeEventListener("message",this._onMessage,!1)}catch(t){}try{this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe)}catch(t){}this._em.emit("destroy")}}async _resolveToken(){const t=this.config.bootstrap||{},{getToken:e,endpoint:i,method:o="GET",headers:r={},payload:n=null,timeoutMs:s=1e4}=t;let a;if("function"==typeof e)a=Promise.resolve().then(()=>e());else{if("string"!=typeof i||!i)throw new J(D,K[D],{hasGetToken:!!e,hasEndpoint:!!i});{const t=(o||"GET").toUpperCase();if("GET"!==t&&"POST"!==t)throw new J(S,K[S],{provided:o,allowed:["GET","POST"]});a=fetch(i,{method:t,headers:r||{},body:"POST"===t&&null!=n?"string"==typeof n?n:JSON.stringify(n):void 0}).then(async t=>{if(!t.ok)throw new J(M,K[M],{status:t.status,statusText:t.statusText,endpoint:i});const e=await t.json().catch(()=>({})),o=e&&e.token;if(!o)throw new J(R,K[R],{endpoint:i,responseKeys:Object.keys(e)});return o})}}const h=await this._withTimeout(a,s);if(!h||"string"!=typeof h)throw new J(N,K[N],{tokenType:typeof h,tokenValue:h?"[REDACTED]":"null"});return h}_withTimeout(t,e){return e?new Promise((i,o)=>{const r=setTimeout(()=>{o(new J(v,K[v],{timeoutMs:e}))},e);t.then(t=>{clearTimeout(r),i(t)},t=>{clearTimeout(r),o(t)})}):t}}const rt=t=>new ot(t);rt.VERSION=t;var nt={init:rt};export{nt as default,rt as init};