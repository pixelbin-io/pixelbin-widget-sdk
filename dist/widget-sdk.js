const t="2.2.1",e="Widget SDK: ",i=/^[A-Za-z0-9._-]{3,128}$/,n=["https://console.pixelbin.io","https://console.pixelbinz0.de"],r="WIDGET_INIT_ACK",o="WIDGET_READY",s="WIDGET_OPENED",a="WIDGET_CLOSED",h="WIDGET_ERROR",d="WIDGET_LOGOUT",l="WIDGET_NAVIGATED",c="WIDGET_SESSION_EXPIRED",g="WIDGET_SESSION_NOT_FOUND",_="SDK_INIT",u="SDK_OPEN",p="SDK_CLOSE",m="SDK_NAVIGATE",f="SDK_LOGOUT",w={params:{widgetType:"ai-editor"},autostart:!1,autoDestroyOnFatalError:!0,allowedIframeFeatures:["clipboard-read","clipboard-write","camera","microphone","geolocation","fullscreen","web-share","autoplay","display-capture"],style:{position:"relative",width:"100%",height:"100%",border:"0",borderRadius:"12px",display:"none"},debug:!1,routePath:"/api/widget",bootstrap:{token:null,getToken:null,endpoint:null,method:"GET",headers:{},payload:null,timeoutMs:1e4}},y=5e3,T=new Set(["CONFIG_MISSING","CONFIG_INVALID_DOM_NODE","CONFIG_INVALID_ORIGIN","CONFIG_INVALID_EMBED_ID","CONFIG_DUPLICATE_INIT","COMM_INIT_TIMEOUT"]),I="CONFIG_MISSING",O="CONFIG_INVALID_DOM_NODE",E="CONFIG_INVALID_ORIGIN",b="CONFIG_INVALID_EMBED_ID",N="CONFIG_DUPLICATE_INIT",v="AUTH_TOKEN_MISSING",D="AUTH_TOKEN_INVALID",k="AUTH_TOKEN_TIMEOUT",A="AUTH_TOKEN_SOURCE_INVALID",S="AUTH_BOOTSTRAP_GETTOKEN_INVALID",M="AUTH_BOOTSTRAP_ENDPOINT_INVALID",R="AUTH_BOOTSTRAP_METHOD_INVALID",G="AUTH_ENDPOINT_FAILED",P="AUTH_ENDPOINT_NO_TOKEN",U="COMM_INIT_TIMEOUT",C="COMM_POSTMESSAGE_FAILED",H="COMM_LOGOUT_TIMEOUT",L="COMM_INVALID_ORIGIN",W="RUNTIME_DESTROYED",j="RUNTIME_NOT_READY",F="RUNTIME_INVALID_URL",K="NETWORK_FETCH_FAILED",x="NETWORK_TIMEOUT",q="UNKNOWN",V={[I]:"Configuration object is required",[O]:"Invalid domNode: must be an HTMLElement or valid CSS selector",[E]:"Invalid widgetOrigin: must be an allowed origin URL",[b]:"Invalid embedId format: must match pattern [A-Za-z0-9._-]{3,128}",[N]:"Widget already initialized on this domNode",[v]:"Bootstrap token is required but not provided",[D]:"Bootstrap token is invalid or malformed",[k]:"Bootstrap token request timed out",[A]:"No valid token source configured (provide getToken or endpoint)",[S]:"bootstrap.getToken must be a function",[M]:"bootstrap.endpoint must be a valid URL string",[R]:"bootstrap.method must be GET or POST",[G]:"Token endpoint request failed",[P]:"Token endpoint did not return a valid token",[U]:"Widget initialization handshake timed out",[C]:"Failed to send message to widget iframe",[H]:"Widget logout acknowledgement timed out",[L]:"Message origin does not match widget origin",[W]:"Widget has been destroyed",[j]:"Widget is not ready yet",[F]:"Invalid URL format for widget origin",[K]:"Network request failed",[x]:"Network request timed out",[q]:"An unknown error occurred"},B=t=>"string"==typeof t,z=t=>{if(t instanceof HTMLElement)return t;if(B(t)){const i=document.querySelector(t);if(!i)throw new Error("".concat(e,"Invalid DOM node: selector not found: ").concat(t));return i}throw new Error("".concat(e,"Invalid DOM node: domNode must be an element or selector"))},Y=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i={};for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(i[e]=t[e]);for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=e[t]);return i};class J{constructor(){this._ev={}}on(t,e){return(this._ev[t]=this._ev[t]||[]).push(e),this}off(t,e){const i=this._ev[t];return i?(this._ev[t]=i.filter(t=>t!==e),this):this}once(t,e){var i=this;const n=function(){try{e(...arguments)}finally{i.off(t,n)}};return this.on(t,n)}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];(this._ev[t]||[]).forEach(t=>{try{t(...i)}catch(t){setTimeout(()=>{throw t},0)}})}}class Q{constructor(t){this.enabled=!!t}log(){if(this.enabled)try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.log("[WidgetSDK]",...e)}catch(t){}}error(){try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.error("[WidgetSDK]",...e)}catch(t){}}warn(){try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.warn("[WidgetSDK]",...e)}catch(t){}}}class Z extends Error{constructor(t,i){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("string"==typeof t&&!i)return super("".concat(e).concat(t)),this.name="SdkError",this.code="UNKNOWN",void(this.context={});super("".concat(e,"[").concat(t,"] ").concat(i)),this.name="SdkError",this.code=t,this.context=n,Error.captureStackTrace&&Error.captureStackTrace(this,Z)}toJSON(){return{name:this.name,code:this.code,message:this.message,context:this.context,stack:this.stack}}getUserMessage(){return this.message.replace(e,"").replace(/^\[.*?\]\s*/,"")}}function $(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function X(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?$(Object(i),!0).forEach(function(e){tt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):$(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function tt(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const et=(t,i)=>{const n=document.createElement("iframe");n.src=((t,i,n)=>{if(!/^https?:\/\//.test(t))throw new Error("".concat(e,"widgetOrigin must be absolute (https://...)"));const r=B(i)&&i.length>0?i.startsWith("/")?i:"/".concat(i):"",o=new URL(t.replace(/\/$/,"")+r);return Object.keys(n||{}).forEach(t=>{const e=n[t];null!=e&&o.searchParams.set(t,String(e))}),o.toString()})(t.widgetOrigin,t.routePath,X(X({},t.params),{},{embedId:t.embedId})),n.sandbox=["allow-scripts","allow-forms","allow-popups","allow-same-origin"].join(" "),n.referrerPolicy="origin-when-cross-origin",n.allow=(t.allowedIframeFeatures||[]).join("; "),n.loading="eager",n.setAttribute("aria-label","Pixelbin Widget"),n.setAttribute("data-widget-sdk","true"),n.setAttribute("data-widget-type",t.params.widgetType),null!=t.embedId&&n.setAttribute("data-embed-id",String(t.embedId)),Object.assign(n.style,w.style,t.style||{});return z(t.domNode).appendChild(n),i("iframe created",n.src),n};class it{constructor(t,e,i){this._logger=t,this._post=e,this._emitError=i,this._initAck=!1,this._initRetryHandle=null,this._initRetryAttempts=0}start(t,e){this._initAck=!1,this._initRetryAttempts=0,this._onReady=e;const i=()=>{if(this._logger.log("INIT attempt",this._initRetryAttempts+1),this._post(_,t),this._initAck)this.clear();else{if(this._initRetryAttempts>=9){this.clear(),this._logger.error("INIT handshake timed out");const t=new Z(U,V[U],{attempts:10,intervalMs:1e3});return void this._emitError(t)}this._initRetryAttempts+=1,this.clear(),this._initRetryHandle=window.setTimeout(i,1e3)}};this.clear(),i()}handleAck(){this._initAck=!0,this.clear()}handleReady(){this._initAck&&this._onReady&&this._onReady()}clear(){this._initRetryHandle&&(clearTimeout(this._initRetryHandle),this._initRetryHandle=null)}isAcknowledged(){return this._initAck}}class nt{constructor(t,e){this._logger=t,this._post=e,this._pending=null,this._timer=null}execute(t,e){const{path:i,widgetType:n,params:r,timeout:o=y}=t;return new Promise((t,s)=>{e(()=>{if(this._pending)return void s(new Error("Navigation already in progress"));const e={};n&&(e.widgetType=n),i&&(e.path=i),r&&(e.params=r),this._pending={resolve:t,reject:s,payload:e},this._post(m,e),this._timer=window.setTimeout(()=>{if(this._pending){this._logger.warn("Navigate acknowledgement timed out");const{reject:t}=this._pending;this._pending=null,this.clear(),t(new Error("Navigation timeout"))}},o)})})}handleAck(t){if(!this._pending)return;const{resolve:e,reject:i}=this._pending;if(this._pending=null,this.clear(),null!=t&&t.error||!1===(null==t?void 0:t.success)){this._logger.error("Navigation failed",t);const e=(null==t?void 0:t.error)||(null==t?void 0:t.message)||"Navigation failed";i(new Error(e))}else this._logger.log("Navigation successful",t),e(t||{})}clear(){this._timer&&(clearTimeout(this._timer),this._timer=null)}cleanup(){this._pending&&(this._pending.reject(new Error("Widget destroyed")),this._pending=null),this.clear()}isPending(){return null!==this._pending}}class rt{constructor(t,e){this._logger=t,this._post=e,this._pending=!1,this._timer=null}start(t){if(this._pending)return!1;this._pending=!0,this._onComplete=t;try{this._post(f,{reason:"destroy"})}catch(e){return this._logger.error("Failed to send LOGOUT",e),this._pending=!1,t&&t(),!1}return this._timer=window.setTimeout(()=>{this._logger.warn("LOGOUT acknowledgement timed out; forcing destroy"),this._pending=!1,this._onComplete&&this._onComplete()},2e3),!0}handleAck(){this._pending&&(this._pending=!1,this.clear(),this._onComplete&&this._onComplete())}clear(){this._timer&&(clearTimeout(this._timer),this._timer=null)}isPending(){return this._pending}}class ot{constructor(t){this._validateConfig(t),this.config=Y(w,t),this._logger=new Q(!!this.config.debug),this._em=new J,this._ready=!1,this._destroyed=!1,this._queue=[],this._authenticating=!1,this._initHandler=new it(this._logger,this._post.bind(this),this._emitError.bind(this)),this._navigateHandler=new nt(this._logger,this._post.bind(this)),this._logoutHandler=new rt(this._logger,this._post.bind(this)),this._setupFrameAndInit()}_setupFrameAndInit(){var t=this;if(z(this.config.domNode).querySelector('iframe[data-widget-sdk="true"]'))throw new Z(N,V[N],{domNode:this.config.domNode});this._logger.log("Creating iframe without btToken (cookie-first flow)"),this.iframe=et(this.config,function(){return t._logger.log(...arguments)}),this._onMessage=this._handleMessage.bind(this),window.addEventListener("message",this._onMessage,!1),this._setupInitHandshake()}_setupInitHandshake(){const e=()=>{const e={version:t,token:null,parentOrigin:window.location.origin,params:this.config.params||{}};null!=this.config.embedId&&(e.embedId=this.config.embedId),this._initHandler.start(e,()=>{this._ready=!0,this._authenticating=!1,this._flushQueue(),this._em.emit("ready"),this.config.autostart&&this.open()})};this.iframe.contentWindow&&this.iframe.contentDocument&&"complete"===this.iframe.contentDocument.readyState?e():this.iframe.addEventListener("load",e,{once:!0})}_handleSessionAuth(t){this._authenticating||this._destroyed||(this._logger.warn("Session requires authentication, fetching token...",t),this._authenticating=!0,this._ready=!1,this._queue=[],this._initHandler.clear(),this._resolveToken().then(t=>{if(this._destroyed)return;this._logger.log("Token obtained, reloading iframe with btToken");const e=new URL(this.iframe.src);e.searchParams.set("btToken",t),this.iframe.src=e.toString(),this._setupInitHandshake()}).catch(t=>{this._logger.error("Token fetch failed during session auth",t),this._authenticating=!1,this._emitError(t,!1)}))}_validateConfig(t){if(!t)throw new Z(I,V[I]);if(!t.domNode)throw new Z(O,V[O],{provided:t.domNode});if(!t.widgetOrigin)throw new Z(E,"widgetOrigin is required (e.g. https://console.pixelbin.io)",{allowed:n});if(-1===n.indexOf(String(t.widgetOrigin)))throw new Z(E,V[E],{provided:t.widgetOrigin,allowed:n});if(null!=t.embedId){const e=String(t.embedId);if(!i.test(e))throw new Z(b,V[b],{provided:e,pattern:i.toString()})}if(t.bootstrap){const e=t.bootstrap;if(e.getToken&&"function"!=typeof e.getToken)throw new Z(S,V[S],{type:typeof e.getToken});if(e.endpoint&&"string"!=typeof e.endpoint)throw new Z(M,V[M],{type:typeof e.endpoint});if(e.method&&!["GET","POST"].includes(String(e.method).toUpperCase()))throw new Z(R,V[R],{provided:e.method,allowed:["GET","POST"]})}}_post(t,e){if(this._destroyed)return;const i=this.config.widgetOrigin,n={type:t,payload:e||{},requestId:"w_".concat(Math.random().toString(36).slice(2)).concat(Date.now().toString(36))};this._logger.log("postMessage →",i,n);try{this.iframe.contentWindow.postMessage(n,i)}catch(e){this._logger.error("postMessage failed",e);const i=new Z(C,V[C],{type:t,originalError:e.message});this._emitError(i)}}_emitError(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=t instanceof Z?{code:t.code,message:t.getUserMessage(),context:t.context}:{code:q,message:t.message,context:{}};this._em.emit("error",i);const n=null!==e?e:t instanceof Z&&T.has(t.code),r=!1!==this.config.autoDestroyOnFatalError;n&&r&&!this._destroyed&&(this._logger.warn("Fatal error [".concat(i.code,"]: Auto-destroying widget")),setTimeout(()=>{this._destroyed||this._finishDestroy()},0))}_handleMessage(t){if(t.source!==this.iframe.contentWindow)return;if(t.origin!==this.config.widgetOrigin)return;const e=t.data||{};if(e&&e.type)switch(this._logger.log("message ←",t.origin,e),e.type){case r:this._initHandler.handleAck();break;case o:this._initHandler.handleReady();break;case s:this._em.emit("open"),this._show();break;case a:this._em.emit("close"),this._hide();break;case h:this._em.emit("error",e.payload||{});break;case d:this._em.emit("logout",e.payload),this._logoutHandler.handleAck();break;case l:this._em.emit("navigate",e.payload),this._navigateHandler.handleAck(e.payload);break;case c:case g:this._handleSessionAuth(e.payload)}}_flushQueue(){const t=this._queue.splice(0,this._queue.length);for(let e=0;e<t.length;e++)t[e]()}_ensureReady(t){this._ready?t():this._queue.push(t)}_show(){this.iframe.style.display="block"}_hide(){this.iframe.style.display="none"}open(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._ensureReady(()=>{const e={};t.imageUrl&&"string"==typeof t.imageUrl&&(e.imageUrl=t.imageUrl),t.widgetType&&(e.widgetType=t.widgetType),this._post(u,e)}),this}close(){return this._ensureReady(()=>{this._post(p),this._hide()}),this}navigate(t){return this._navigateHandler.execute(t||{},this._ensureReady.bind(this))}updateConfig(t){return(e=t)&&"object"==typeof e?(this.config=Y(this.config,t),this):this;var e}on(t,e){return this._em.on(t,e),this}off(t,e){return this._em.off(t,e),this}once(t,e){return this._em.once(t,e),this}destroy(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{force:e=!1}=t;this._destroyed||(!e&&this.iframe&&this.iframe.contentWindow?this._logoutHandler.isPending()||this._logoutHandler.start(()=>{this._finishDestroy()}):this._finishDestroy())}_finishDestroy(){if(!this._destroyed){this._destroyed=!0,this._ready=!1,this._authenticating=!1,this._queue=[],this._initHandler.clear(),this._logoutHandler.clear(),this._navigateHandler.cleanup();try{window.removeEventListener("message",this._onMessage,!1)}catch(t){}try{this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe)}catch(t){}this._em.emit("destroy")}}async _resolveToken(){const t=this.config.bootstrap||{},{getToken:e,endpoint:i,method:n="GET",headers:r={},payload:o=null,timeoutMs:s=1e4}=t;let a;if("function"==typeof e)a=Promise.resolve().then(()=>e());else{if("string"!=typeof i||!i)throw new Z(A,V[A],{hasGetToken:!!e,hasEndpoint:!!i});{const t=(n||"GET").toUpperCase();if("GET"!==t&&"POST"!==t)throw new Z(R,V[R],{provided:n,allowed:["GET","POST"]});a=fetch(i,{method:t,headers:r||{},body:"POST"===t&&null!=o?"string"==typeof o?o:JSON.stringify(o):void 0}).then(async t=>{if(!t.ok)throw new Z(G,V[G],{status:t.status,statusText:t.statusText,endpoint:i});const e=await t.json().catch(()=>({})),n=e&&e.token;if(!n)throw new Z(P,V[P],{endpoint:i,responseKeys:Object.keys(e)});return n})}}const h=await this._withTimeout(a,s);if(!h||"string"!=typeof h)throw new Z(D,V[D],{tokenType:typeof h,tokenValue:h?"[REDACTED]":"null"});return h}_withTimeout(t,e){return e?new Promise((i,n)=>{const r=setTimeout(()=>{n(new Z(k,V[k],{timeoutMs:e}))},e);t.then(t=>{clearTimeout(r),i(t)},t=>{clearTimeout(r),n(t)})}):t}}const st=t=>new ot(t);st.VERSION=t;var at={init:st};export{at as default,st as init};