const t="1.0.0",e="Widget SDK: ",i=/^[A-Za-z0-9._-]{3,128}$/,r=["https://console.pixelbin.io","https://console.pixelbinz0.de"],o="WIDGET_INIT_ACK",n="WIDGET_READY",s="WIDGET_OPENED",a="WIDGET_CLOSED",h="WIDGET_ERROR",d="WIDGET_LOGOUT",l="WIDGET_NAVIGATED",c="WIDGET_SESSION_EXPIRED",g="SDK_INIT",_="SDK_OPEN",u="SDK_CLOSE",p="SDK_NAVIGATE",m="SDK_LOGOUT",f={params:{widgetType:"ai-editor"},autostart:!1,autoDestroyOnFatalError:!0,allowedIframeFeatures:["clipboard-read","clipboard-write","camera","microphone","geolocation","fullscreen","web-share","autoplay","display-capture"],style:{position:"relative",width:"100%",height:"100%",border:"0",borderRadius:"12px",display:"none"},debug:!1,routePath:"/widget",bootstrap:{token:null,getToken:null,endpoint:null,method:"GET",headers:{},payload:null,timeoutMs:1e4}},w=5e3,y=new Set(["CONFIG_MISSING","CONFIG_INVALID_DOM_NODE","CONFIG_INVALID_ORIGIN","CONFIG_INVALID_EMBED_ID","CONFIG_DUPLICATE_INIT","COMM_INIT_TIMEOUT"]),T="CONFIG_MISSING",I="CONFIG_INVALID_DOM_NODE",O="CONFIG_INVALID_ORIGIN",E="CONFIG_INVALID_EMBED_ID",b="CONFIG_DUPLICATE_INIT",N="AUTH_TOKEN_MISSING",v="AUTH_TOKEN_INVALID",k="AUTH_TOKEN_TIMEOUT",A="AUTH_TOKEN_SOURCE_INVALID",D="AUTH_BOOTSTRAP_GETTOKEN_INVALID",S="AUTH_BOOTSTRAP_ENDPOINT_INVALID",M="AUTH_BOOTSTRAP_METHOD_INVALID",R="AUTH_ENDPOINT_FAILED",G="AUTH_ENDPOINT_NO_TOKEN",P="COMM_INIT_TIMEOUT",U="COMM_POSTMESSAGE_FAILED",C="COMM_LOGOUT_TIMEOUT",L="COMM_INVALID_ORIGIN",H="RUNTIME_DESTROYED",j="RUNTIME_NOT_READY",W="RUNTIME_INVALID_URL",F="NETWORK_FETCH_FAILED",x="NETWORK_TIMEOUT",K="UNKNOWN",V={[T]:"Configuration object is required",[I]:"Invalid domNode: must be an HTMLElement or valid CSS selector",[O]:"Invalid widgetOrigin: must be an allowed origin URL",[E]:"Invalid embedId format: must match pattern [A-Za-z0-9._-]{3,128}",[b]:"Widget already initialized on this domNode",[N]:"Bootstrap token is required but not provided",[v]:"Bootstrap token is invalid or malformed",[k]:"Bootstrap token request timed out",[A]:"No valid token source configured (provide getToken or endpoint)",[D]:"bootstrap.getToken must be a function",[S]:"bootstrap.endpoint must be a valid URL string",[M]:"bootstrap.method must be GET or POST",[R]:"Token endpoint request failed",[G]:"Token endpoint did not return a valid token",[P]:"Widget initialization handshake timed out",[U]:"Failed to send message to widget iframe",[C]:"Widget logout acknowledgement timed out",[L]:"Message origin does not match widget origin",[H]:"Widget has been destroyed",[j]:"Widget is not ready yet",[W]:"Invalid URL format for widget origin",[F]:"Network request failed",[x]:"Network request timed out",[K]:"An unknown error occurred"},q=t=>"string"==typeof t,z=t=>{if(t instanceof HTMLElement)return t;if(q(t)){const i=document.querySelector(t);if(!i)throw new Error("".concat(e,"Invalid DOM node: selector not found: ").concat(t));return i}throw new Error("".concat(e,"Invalid DOM node: domNode must be an element or selector"))},B=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i={};for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(i[e]=t[e]);for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=e[t]);return i};class Y{constructor(){this._ev={}}on(t,e){return(this._ev[t]=this._ev[t]||[]).push(e),this}off(t,e){const i=this._ev[t];return i?(this._ev[t]=i.filter(t=>t!==e),this):this}once(t,e){var i=this;const r=function(){try{e(...arguments)}finally{i.off(t,r)}};return this.on(t,r)}emit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];(this._ev[t]||[]).forEach(t=>{try{t(...i)}catch(t){setTimeout(()=>{throw t},0)}})}}class J{constructor(t){this.enabled=!!t}log(){if(this.enabled)try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.log("[WidgetSDK]",...e)}catch(t){}}error(){try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.error("[WidgetSDK]",...e)}catch(t){}}warn(){try{for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];console.warn("[WidgetSDK]",...e)}catch(t){}}}class Q extends Error{constructor(t,i){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("string"==typeof t&&!i)return super("".concat(e).concat(t)),this.name="SdkError",this.code="UNKNOWN",void(this.context={});super("".concat(e,"[").concat(t,"] ").concat(i)),this.name="SdkError",this.code=t,this.context=r,Error.captureStackTrace&&Error.captureStackTrace(this,Q)}toJSON(){return{name:this.name,code:this.code,message:this.message,context:this.context,stack:this.stack}}getUserMessage(){return this.message.replace(e,"").replace(/^\[.*?\]\s*/,"")}}function Z(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)}return i}function $(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Z(Object(i),!0).forEach(function(e){X(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Z(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function X(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const tt=(t,i)=>{const r=document.createElement("iframe");r.src=((t,i,r)=>{if(!/^https?:\/\//.test(t))throw new Error("".concat(e,"widgetOrigin must be absolute (https://...)"));const o=q(i)&&i.length>0?i.startsWith("/")?i:"/".concat(i):"",n=new URL(t.replace(/\/$/,"")+o);return Object.keys(r||{}).forEach(t=>{const e=r[t];null!=e&&n.searchParams.set(t,String(e))}),n.toString()})(t.widgetOrigin,t.routePath,$($({},t.params),{},{embedId:t.embedId})),r.sandbox=["allow-scripts","allow-forms","allow-popups","allow-same-origin"].join(" "),r.referrerPolicy="origin-when-cross-origin",r.allow=(t.allowedIframeFeatures||[]).join("; "),r.loading="eager",r.setAttribute("aria-label","Pixelbin Widget"),r.setAttribute("data-widget-sdk","true"),r.setAttribute("data-widget-type",t.params.widgetType),null!=t.embedId&&r.setAttribute("data-embed-id",String(t.embedId)),Object.assign(r.style,f.style,t.style||{});return z(t.domNode).appendChild(r),i("iframe created",r.src),r};class et{constructor(t,e,i){this._logger=t,this._post=e,this._emitError=i,this._initAck=!1,this._initRetryHandle=null,this._initRetryAttempts=0}start(t,e){this._initAck=!1,this._initRetryAttempts=0,this._onReady=e;const i=()=>{if(this._logger.log("INIT attempt",this._initRetryAttempts+1),this._post(g,t),this._initAck)this.clear();else{if(this._initRetryAttempts>=9){this.clear(),this._logger.error("INIT handshake timed out");const t=new Q(P,V[P],{attempts:10,intervalMs:1e3});return void this._emitError(t)}this._initRetryAttempts+=1,this.clear(),this._initRetryHandle=window.setTimeout(i,1e3)}};this.clear(),i()}handleAck(){this._initAck=!0,this.clear()}handleReady(){this._initAck&&this._onReady&&this._onReady()}clear(){this._initRetryHandle&&(clearTimeout(this._initRetryHandle),this._initRetryHandle=null)}isAcknowledged(){return this._initAck}}class it{constructor(t,e){this._logger=t,this._post=e,this._pending=null,this._timer=null}execute(t,e){const{path:i,widgetType:r,params:o,timeout:n=w}=t;return new Promise((t,s)=>{e(()=>{if(this._pending)return void s(new Error("Navigation already in progress"));const e={};r&&(e.widgetType=r),i&&(e.path=i),o&&(e.params=o),this._pending={resolve:t,reject:s,payload:e},this._post(p,e),this._timer=window.setTimeout(()=>{if(this._pending){this._logger.warn("Navigate acknowledgement timed out");const{reject:t}=this._pending;this._pending=null,this.clear(),t(new Error("Navigation timeout"))}},n)})})}handleAck(t){if(!this._pending)return;const{resolve:e,reject:i}=this._pending;if(this._pending=null,this.clear(),null!=t&&t.error||!1===(null==t?void 0:t.success)){this._logger.error("Navigation failed",t);const e=(null==t?void 0:t.error)||(null==t?void 0:t.message)||"Navigation failed";i(new Error(e))}else this._logger.log("Navigation successful",t),e(t||{})}clear(){this._timer&&(clearTimeout(this._timer),this._timer=null)}cleanup(){this._pending&&(this._pending.reject(new Error("Widget destroyed")),this._pending=null),this.clear()}isPending(){return null!==this._pending}}class rt{constructor(t,e){this._logger=t,this._post=e,this._pending=!1,this._timer=null}start(t){if(this._pending)return!1;this._pending=!0,this._onComplete=t;try{this._post(m,{reason:"destroy"})}catch(e){return this._logger.error("Failed to send LOGOUT",e),this._pending=!1,t&&t(),!1}return this._timer=window.setTimeout(()=>{this._logger.warn("LOGOUT acknowledgement timed out; forcing destroy"),this._pending=!1,this._onComplete&&this._onComplete()},2e3),!0}handleAck(){this._pending&&(this._pending=!1,this.clear(),this._onComplete&&this._onComplete())}clear(){this._timer&&(clearTimeout(this._timer),this._timer=null)}isPending(){return this._pending}}class ot{constructor(t){this._validateConfig(t),this.config=B(f,t),this._logger=new J(!!this.config.debug),this._em=new Y,this._ready=!1,this._destroyed=!1,this._queue=[],this._reinitializing=!1,this._initHandler=new et(this._logger,this._post.bind(this),this._emitError.bind(this)),this._navigateHandler=new it(this._logger,this._post.bind(this)),this._logoutHandler=new rt(this._logger,this._post.bind(this)),this._setupFrameAndInit()}_setupFrameAndInit(){var e=this;const i=this.config.bootstrap||{},r=!(!i.getToken&&!i.endpoint||i.token),o="btToken",n=()=>{if(z(this.config.domNode).querySelector('iframe[data-widget-sdk="true"]'))throw new Q(b,V[b],{domNode:this.config.domNode});const r=this.config.bootstrap&&this.config.bootstrap.token?B(this.config,{params:B(this.config.params||{},{[o]:i.token})}):this.config;this._logger.log("cfgForIframe",r),this.iframe=tt(r,function(){return e._logger.log(...arguments)}),this._onMessage=this._handleMessage.bind(this),window.addEventListener("message",this._onMessage,!1);const n=()=>{const e={version:t,token:null,parentOrigin:window.location.origin,params:this.config.params||{}};null!=this.config.embedId&&(e.embedId=this.config.embedId),this._initHandler.start(e,()=>{this._ready=!0,this._flushQueue(),this._em.emit("ready"),this.config.autostart&&this.open()})};this.iframe.contentWindow&&this.iframe.contentDocument&&"complete"===this.iframe.contentDocument.readyState?n():this.iframe.addEventListener("load",n,{once:!0})};!r||this.config.bootstrap&&this.config.bootstrap.token?n():this._resolveToken().then(t=>{this.config.bootstrap.token=t,n()}).catch(t=>{this._logger.error("Token error",t),this._emitError(t,!1)})}_validateConfig(t){if(!t)throw new Q(T,V[T]);if(!t.domNode)throw new Q(I,V[I],{provided:t.domNode});if(!t.widgetOrigin)throw new Q(O,"widgetOrigin is required (e.g. https://console.pixelbin.io)",{allowed:r});if(-1===r.indexOf(String(t.widgetOrigin)))throw new Q(O,V[O],{provided:t.widgetOrigin,allowed:r});if(null!=t.embedId){const e=String(t.embedId);if(!i.test(e))throw new Q(E,V[E],{provided:e,pattern:i.toString()})}if(t.bootstrap){const e=t.bootstrap;if(e.getToken&&"function"!=typeof e.getToken)throw new Q(D,V[D],{type:typeof e.getToken});if(e.endpoint&&"string"!=typeof e.endpoint)throw new Q(S,V[S],{type:typeof e.endpoint});if(e.method&&!["GET","POST"].includes(String(e.method).toUpperCase()))throw new Q(M,V[M],{provided:e.method,allowed:["GET","POST"]})}}_post(t,e){if(this._destroyed)return;const i=this.config.widgetOrigin,r={type:t,payload:e||{},requestId:"w_".concat(Math.random().toString(36).slice(2)).concat(Date.now().toString(36))};this._logger.log("postMessage →",i,r);try{this.iframe.contentWindow.postMessage(r,i)}catch(e){this._logger.error("postMessage failed",e);const i=new Q(U,V[U],{type:t,originalError:e.message});this._emitError(i)}}_emitError(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=t instanceof Q?{code:t.code,message:t.getUserMessage(),context:t.context}:{code:K,message:t.message,context:{}};this._em.emit("error",i);const r=null!==e?e:t instanceof Q&&y.has(t.code),o=!1!==this.config.autoDestroyOnFatalError;r&&o&&!this._destroyed&&(this._logger.warn("Fatal error [".concat(i.code,"]: Auto-destroying widget")),setTimeout(()=>{this._destroyed||this._finishDestroy()},0))}_handleMessage(t){if(t.source!==this.iframe.contentWindow)return;if(t.origin!==this.config.widgetOrigin)return;const e=t.data||{};if(e&&e.type)switch(this._logger.log("message ←",t.origin,e),e.type){case o:this._initHandler.handleAck();break;case n:this._initHandler.handleReady();break;case s:this._em.emit("open"),this._show();break;case a:this._em.emit("close"),this._hide();break;case h:this._em.emit("error",e.payload||{});break;case d:this._em.emit("logout",e.payload),this._logoutHandler.handleAck();break;case l:this._em.emit("navigate",e.payload),this._navigateHandler.handleAck(e.payload);break;case c:this._handleSessionExpired(e.payload)}}_handleSessionExpired(t){if(!this._reinitializing&&!this._destroyed){this._logger.warn("Session expired, reinitializing widget...",t),this._reinitializing=!0,this._ready=!1,this._queue=[];try{window.removeEventListener("message",this._onMessage,!1),this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe)}catch(t){this._logger.error("Error cleaning up during reinitialization",t)}this.config.bootstrap&&(this.config.bootstrap.token=null),setTimeout(()=>{this._reinitializing=!1,this._setupFrameAndInit()},100)}}_flushQueue(){const t=this._queue.splice(0,this._queue.length);for(let e=0;e<t.length;e++)t[e]()}_ensureReady(t){this._ready?t():this._queue.push(t)}_show(){this.iframe.style.display="block"}_hide(){this.iframe.style.display="none"}open(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._ensureReady(()=>{const e={};t.imageUrl&&"string"==typeof t.imageUrl&&(e.imageUrl=t.imageUrl),t.widgetType&&(e.widgetType=t.widgetType),this._post(_,e)}),this}close(){return this._ensureReady(()=>{this._post(u),this._hide()}),this}navigate(t){return this._navigateHandler.execute(t||{},this._ensureReady.bind(this))}updateConfig(t){return(e=t)&&"object"==typeof e?(this.config=B(this.config,t),this):this;var e}on(t,e){return this._em.on(t,e),this}off(t,e){return this._em.off(t,e),this}once(t,e){return this._em.once(t,e),this}destroy(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{force:e=!1}=t;this._destroyed||(!e&&this.iframe&&this.iframe.contentWindow?this._logoutHandler.isPending()||this._logoutHandler.start(()=>{this._finishDestroy()}):this._finishDestroy())}_finishDestroy(){if(!this._destroyed){this._destroyed=!0,this._ready=!1,this._reinitializing=!1,this._queue=[],this._initHandler.clear(),this._logoutHandler.clear(),this._navigateHandler.cleanup();try{window.removeEventListener("message",this._onMessage,!1)}catch(t){}try{this.iframe&&this.iframe.parentNode&&this.iframe.parentNode.removeChild(this.iframe)}catch(t){}this._em.emit("destroy")}}async _resolveToken(){const t=this.config.bootstrap||{},{getToken:e,endpoint:i,method:r="GET",headers:o={},payload:n=null,timeoutMs:s=1e4}=t;let a;if("function"==typeof e)a=Promise.resolve().then(()=>e());else{if("string"!=typeof i||!i)throw new Q(A,V[A],{hasGetToken:!!e,hasEndpoint:!!i});{const t=(r||"GET").toUpperCase();if("GET"!==t&&"POST"!==t)throw new Q(M,V[M],{provided:r,allowed:["GET","POST"]});a=fetch(i,{method:t,headers:o||{},body:"POST"===t&&null!=n?"string"==typeof n?n:JSON.stringify(n):void 0}).then(async t=>{if(!t.ok)throw new Q(R,V[R],{status:t.status,statusText:t.statusText,endpoint:i});const e=await t.json().catch(()=>({})),r=e&&e.token;if(!r)throw new Q(G,V[G],{endpoint:i,responseKeys:Object.keys(e)});return r})}}const h=await this._withTimeout(a,s);if(!h||"string"!=typeof h)throw new Q(v,V[v],{tokenType:typeof h,tokenValue:h?"[REDACTED]":"null"});return h}_withTimeout(t,e){return e?new Promise((i,r)=>{const o=setTimeout(()=>{r(new Q(k,V[k],{timeoutMs:e}))},e);t.then(t=>{clearTimeout(o),i(t)},t=>{clearTimeout(o),r(t)})}):t}}const nt=t=>new ot(t);nt.VERSION=t;var st={init:nt};export{st as default,nt as init};